<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פרופיל | Smart Parenting</title>
  <meta name="description" content="פרופיל אישי - Smart Parenting | הורות חכמה" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Header -->
  <header aria-label="סרגל עליון">
    <div class="container nav" role="navigation" aria-label="ניווט ראשי">
      <div class="brand">הורות חכמה <small>| Smart Parenting</small></div>
      <nav class="menu">
        <a href="index.html">דף הבית</a>
        <a href="about.html">אודות</a>
        <a href="profile.html" aria-current="page">פרופיל</a>
        <a href="ai.html">יועץ AI</a>
        <a href="community.html">הקהילה</a>
        <a href="surveys.html">שאלונים</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- Hero -->
    <section class="hero">
      <div class="container">
        <span class="eyebrow" id="profileBadge">האזור האישי</span>
        <h1 id="profileHello">היי, משתמש</h1>
        <p class="lead" id="profileLead">
          כאן תראי מידע מותאם אישית על ההריון/הילדים שלך, היסטוריית שאלות וסטטוס מטבעות.
        </p>

        <div class="btn-row" style="margin-top:18px;">
          <a class="btn btn-primary" href="ai.html">מעבר ליועץ AI</a>
          <a class="btn btn-ghost" href="surveys.html">מילוי שאלונים</a>
          <a class="btn btn-ghost" href="#" id="logoutBtn">התנתקות</a>
        </div>
      </div>
    </section>

    <!-- Status -->
    <section style="padding: 26px 0 60px;">
      <div class="container">
        <h2 style="text-align:center; margin: 0 0 6px;">הסטטוס שלי</h2>
        <div class="muted" style="text-align:center; margin-bottom: 18px;" id="profileInfo">
          טוען נתונים…
        </div>

        <!-- Cards row -->
        <div class="grid-3" style="margin-top: 14px;">
          <!-- Pregnancy / Parent card -->
          <div class="card">
            <h3 id="cardTitle">סטטוס</h3>
            <div class="muted" id="cardLine1">—</div>
            <div class="muted" id="cardLine2">—</div>
          </div>

          <!-- Kids card -->
          <div class="card">
            <h3>הילדים שלי</h3>
            <div class="muted">מספר ילדים: <b id="kidsCount">—</b></div>
            <div class="muted">שמות: <b id="kidsNames">—</b></div>
          </div>

          <!-- Coins / activity card (כרגע סטטי עד שתחליטי איך לשמור) -->
          <div class="card">
            <h3>מטבעות</h3>
            <div class="muted">יתרה: <b id="coins">—</b></div>
            <div class="muted">פעולות אחרונות: <span id="activity">—</span></div>
          </div>
        </div>

        <!-- Optional debug tiny line -->
        <div class="muted" style="margin-top:14px; font-size:0.95rem;">
          מחובר כ־ <span id="userEmail">—</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div class="foot">
        <div class="brand" style="margin-bottom:6px;">Smart Parenting | הורות חכמה</div>
        <div class="muted">© 2026 — פרויקט גמר.</div>
      </div>
      <div class="foot"><h4>אודות</h4><a href="about.html">על הפלטפורמה</a><br/><a href="about.html#team">הצוות</a></div>
      <div class="foot"><h4>פרטיות</h4><a href="privacy.html">מדיניות פרטיות</a><br/><a href="terms.html">תנאי שימוש</a></div>
      <div class="foot"><h4>חברתי</h4><a href="#">Facebook</a><br/><a href="#">Instagram</a></div>
    </div>
  </footer>

  <script>
    // ===== Logout =====
    const logoutBtn = document.getElementById("logoutBtn");
    function logout(e){
      if (e) e.preventDefault();
      localStorage.removeItem("sp_token");
      window.location.href = "login.html";
    }
    if (logoutBtn) logoutBtn.addEventListener("click", logout);

    // ===== Helpers =====
    function safeText(x, fallback="—"){
      if (x === null || x === undefined) return fallback;
      const s = String(x).trim();
      return s ? s : fallback;
    }

    function asNumber(val, fallback=0){
      const n = Number(val);
      return Number.isFinite(n) ? n : fallback;
    }

    function normalizeKidsNames(val){
      // אם אין לך עדיין children_names בטבלה - זה יחזיר []
      if (val === null || val === undefined) return [];

      if (Array.isArray(val)) {
        return val.map(x => String(x).trim()).filter(Boolean);
      }

      // אם זה טקסט JSON כמו '["אורי","נועה"]'
      if (typeof val === "string") {
        const s = val.trim();
        if (!s) return [];
        try {
          const parsed = JSON.parse(s);
          if (Array.isArray(parsed)) return parsed.map(x => String(x).trim()).filter(Boolean);
        } catch {}
        // אם זה סתם "אורי, נועה"
        if (s.includes(",")) return s.split(",").map(x => x.trim()).filter(Boolean);
        // מילה אחת
        return [s];
      }

      return [];
    }

    function isPregnantType(t){
      return t === "pregnant" || t === "both";
    }
    function isParentType(t){
      return t === "parent" || t === "both";
    }

    // ===== UI setters =====
    function setText(id, text){
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function setHTML(id, html){
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    }

    // ===== Main loader =====
    async function loadMe(){
      const token = localStorage.getItem("sp_token");
      if (!token){
        window.location.href = "login.html";
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/me", {
          method: "GET",
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          // טוקן לא תקין/פג תוקף/שגיאה אחרת
          localStorage.removeItem("sp_token");
          window.location.href = "login.html";
          return;
        }

        const u = data.user || {};
        const userType = safeText(u.user_type, "").toLowerCase();

        // כותרת: "היי, <שם>"
        setText("profileHello", "היי, " + safeText(u.full_name, "משתמש"));

        // אימייל למטה
        setText("userEmail", safeText(u.email));

        // סטטוס עליון קצר
        const childrenCount = asNumber(u.children_count, 0);
        const pregnancyWeek = (u.pregnancy_week === null || u.pregnancy_week === undefined) ? null : asNumber(u.pregnancy_week, null);

        let info = "פרופיל נטען מהמערכת";
        if (isPregnantType(userType) && isParentType(userType)) {
          info = "בהיריון וגם הורה לילדים • שבוע " + safeText(pregnancyWeek, "—") + " • ילדים: " + String(childrenCount);
        } else if (isPregnantType(userType)) {
          info = "בהיריון • שבוע " + safeText(pregnancyWeek, "—");
        } else if (isParentType(userType)) {
          info = "הורה לילדים • מספר ילדים: " + String(childrenCount);
        }
        setText("profileInfo", info);

        // כרטיס סטטוס ראשי
        if (isPregnantType(userType) && isParentType(userType)) {
          setText("cardTitle", "סטטוס משפחה");
          setHTML("cardLine1", "הריון: שבוע <b>" + safeText(pregnancyWeek, "—") + "</b>");
          setHTML("cardLine2", "מספר ילדים: <b>" + String(childrenCount) + "</b>");
        } else if (isPregnantType(userType)) {
          setText("cardTitle", "סטטוס הריון");
          setHTML("cardLine1", "שבוע: <b>" + safeText(pregnancyWeek, "—") + "</b>");
          setHTML("cardLine2", "תאריך יעד: <b>—</b>");
        } else if (isParentType(userType)) {
          setText("cardTitle", "סטטוס הורה");
          setHTML("cardLine1", "מספר ילדים: <b>" + String(childrenCount) + "</b>");
          setText("cardLine2", "התאמות תוכן לפי גילאים (בהמשך)");
        } else {
          setText("cardTitle", "סטטוס");
          setText("cardLine1", "—");
          setText("cardLine2", "—");
        }

        // כרטיס ילדים
        const shouldShowKids = isParentType(userType);
        setText("kidsCount", shouldShowKids ? String(childrenCount) : "0");

        const kidsNamesArr = normalizeKidsNames(u.children_names);
        setText("kidsNames", (kidsNamesArr.length ? kidsNamesArr.join(", ") : "—"));

        // מטבעות (placeholder)
        setText("coins", "—");
        setText("activity", "מילוי שאלונים (בשלב הבא)");

      } catch (err) {
        console.log(err);
        setText("profileInfo", "יש בעיית תקשורת. בדקי שה-Deploy הצליח ושיש פונקציה me.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadMe);
  </script>
</body>
</html>
